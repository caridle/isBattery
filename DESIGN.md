# 电源监控程序设计文档

## 项目概述
一个基于Rust开发的Windows电源状态监控工具，具备图形界面、系统托盘和智能提醒功能。

## 功能规格

### 1. 核心监控功能
- **检测频率**：每10秒检测一次电源连接状态
- **检测方式**：调用Windows API获取电源状态
- **状态类型**：
  - 外接电源已连接
  - 仅使用电池电源
  - 电池状态（可选显示）

### 2. 提醒系统
#### 弹窗提醒
- **触发条件**：
  - 检测到未连接外接电源
  - 电池电量低于20%（无论是否连接电源）
- **提醒类型**：
  - **电源断开提醒**：橙色背景，提示连接电源
  - **低电量提醒**：红色背景，提示电量不足
- **窗口特性**：
  - 简洁设计，显示核心信息
  - 窗口置顶显示（TOPMOST）
  - 持续高亮效果
  - 特定颜色方案（电源断开：橙色 / 低电量：红色）
- **声音提醒**：播放系统警告音或自定义音效
- **自动关闭**：检测到电源重新连接且电量充足后自动关闭提醒窗口

#### 提醒内容
- **电源断开提醒**：
  - 主要信息："请连接电源适配器"
  - 电池电量百分比
  - 当前时间
  - 暂停提醒按钮
- **低电量提醒**：
  - 主要信息："电池电量不足！请及时充电"
  - 电池电量百分比
  - 当前时间
  - 暂停提醒按钮

### 3. 系统托盘功能
#### 托盘图标
- **电源已连接**：绿色充电图标
- **电池供电**：橙色/红色电池图标
- **程序暂停**：灰色图标

#### 右键菜单
- **显示状态**：当前电源状态和电池电量
- **设置**：打开设置窗口
- **暂停监控**：临时停止电源检测（不计时，手动恢复）
- **恢复监控**：重新开始检测
- **开机启动**：切换自启动状态
- **关于**：程序版本和信息
- **退出**：关闭程序

### 4. 设置系统
#### 配置文件位置
- Windows: `%APPDATA%\isBattery\config.toml`

#### 可配置项
```toml
[monitoring]
check_interval = 10  # 检测间隔（秒）
sound_enabled = true  # 是否启用声音
auto_close_alert = true  # 电源连接后自动关闭提醒
low_battery_threshold = 20  # 低电量阿值（百分比）

[ui]
alert_color = "#FF6B35"  # 电源断开提醒窗口颜色
low_battery_color = "#FF0000"  # 低电量提醒窗口颜色
window_opacity = 0.95  # 窗口透明度
always_on_top = true  # 窗口置顶

[system]
auto_startup = false  # 开机自启动
minimize_to_tray = true  # 最小化到托盘
```

### 5. 暂停提醒功能
- **触发方式**：托盘菜单或提醒窗口按钮
- **暂停状态**：
  - 停止电源检测
  - 托盘图标变为灰色
  - 菜单显示"恢复监控"选项
- **恢复方式**：用户手动点击恢复（不自动计时）

## 技术架构

### 开发技术栈
- **语言**：Rust 2021 Edition
- **GUI框架**：`tauri` - 提供现代化的Web技术GUI
- **托盘功能**：`tray-icon` - 系统托盘支持
- **系统API**：`windows` crate - Windows API调用
- **通知系统**：`notify-rust` - 跨平台通知
- **音频播放**：`rodio` - 声音提醒
- **配置管理**：`serde` + `toml` - 配置文件处理
- **自启动**：`auto-launch` - 开机启动管理

### 项目结构
```
src/
├── main.rs              # 程序入口
├── power/
│   ├── mod.rs          # 电源模块
│   ├── detector.rs     # 电源状态检测
│   └── monitor.rs      # 监控服务
├── ui/
│   ├── mod.rs          # UI模块
│   ├── tray.rs         # 托盘管理
│   ├── alert.rs        # 提醒窗口
│   └── settings.rs     # 设置界面
├── config/
│   ├── mod.rs          # 配置模块
│   ├── manager.rs      # 配置管理器
│   └── storage.rs      # 配置存储
├── audio/
│   ├── mod.rs          # 音频模块
│   └── player.rs       # 音效播放
└── utils/
    ├── mod.rs          # 工具模块
    ├── startup.rs      # 自启动管理
    └── logger.rs       # 日志记录

assets/
├── icons/              # 托盘图标
│   ├── connected.ico   # 已连接电源
│   ├── battery.ico     # 电池供电
│   └── paused.ico      # 暂停状态
└── sounds/
    └── alert.wav       # 提醒音效

tauri-src/              # Tauri前端资源
├── index.html          # 设置界面HTML
├── style.css           # 样式文件
└── script.js           # 交互脚本
```

## 用户体验流程

### 启动流程
1. 程序启动，显示托盘图标
2. 读取配置文件，应用用户设置
3. 开始电源状态监控
4. 根据当前状态更新托盘图标

### 监控流程
1. 每10秒检测电源状态和电池电量
2. 状态变化时更新托盘图标
3. 检测到以下情况时触发提醒：
   - 电池供电（未连接外接电源）
   - 电池电量低于20%（无论是否连接电源）
4. 提醒操作：
   - 显示提醒窗口（置顶、高亮）
   - 播放提醒音效
   - 等待用户操作或状态恢复

### 设置流程
1. 右键托盘图标选择"设置"
2. 打开设置窗口（Tauri界面）
3. 修改配置项
4. 保存并应用新设置

## 开发里程碑

1. **基础框架搭建**（第1阶段）
   - Rust项目初始化
   - 基本依赖配置
   - 项目结构创建

2. **电源检测功能**（第2阶段）
   - Windows API集成
   - 电源状态检测逻辑
   - 定时监控服务

3. **托盘功能实现**（第3阶段）
   - 托盘图标显示
   - 右键菜单
   - 状态图标切换

4. **提醒系统开发**（第4阶段）
   - 提醒窗口设计
   - 音效播放
   - 窗口置顶和高亮

5. **配置和设置**（第5阶段）
   - 配置文件管理
   - 设置界面（Tauri）
   - 自启动功能

6. **测试和优化**（第6阶段）
   - 功能测试
   - 性能优化
   - 用户体验改进

## 质量保证

### 错误处理
- 电源API调用失败的降级处理
- 配置文件损坏的恢复机制
- 音频播放失败的静默处理

### 性能考虑
- 低CPU占用的检测逻辑
- 最小内存占用
- 快速启动时间

### 用户友好性
- 清晰的界面设计
- 直观的交互逻辑
- 详细的错误提示